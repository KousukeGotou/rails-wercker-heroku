box: ruby:2.4.2

services:
  - id: postgres
    env:
      POSTGRES_PASSWORD: secret_password
build:
    steps:
      - script:
          name: Clear bundle cache
          code: rm -rf /pipeline/cache/bundle-install/ruby/2.4.2/cache/bundler/git/*

      - bundle-install
      - rails-database-yml:
          service: postgresql-docker
      - script:
          name: echo ruby information
          code: |
              echo "ruby version $(ruby --version) running!"
              echo "from location $(which ruby)"
              echo -p "gem list: $(gem list)"
      - script:
          name: Set up db
          code: RAILS_ENV=test bundle exec rake db:schema:load
      - script:
          name: Run RSpec
          code: bundle exec rspec